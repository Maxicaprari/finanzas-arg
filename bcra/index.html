<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BCRA · Monitor Económico</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
:root {
  --bg:      #0a0d12;
  --surface: #111318;
  --surface2:#161b22;
  --surface3:#1c2128;
  --border:  #21262d;
  --border2: #30363d;
  --text:    #e6edf3;
  --muted:   #8b949e;
  --muted2:  #6e7681;
  --accent:  #58a6ff;
  --green:   #3fb950;
  --red:     #f85149;
  --yellow:  #d29922;
  --mono:    'IBM Plex Mono', monospace;
  --sans:    'IBM Plex Sans', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  font-size: 14px;
  line-height: 1.6;
  min-height: 100vh;
}

/* ── TOPBAR ──────────────────────────────────────────── */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(10,13,18,.92);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 48px;
  display: flex; align-items: center; gap: 12px;
}
.back-link {
  font-family: var(--mono); font-size: 0.72rem;
  color: var(--muted); text-decoration: none;
  padding: 3px 8px; border-radius: 4px;
  border: 1px solid var(--border);
  transition: color .15s, border-color .15s;
}
.back-link:hover { color: var(--accent); border-color: var(--accent); }
.topbar-title { font-family: var(--mono); font-size: 0.85rem; font-weight: 600; }
.topbar-sep   { color: var(--border2); }
.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
#timestamp    { font-family: var(--mono); font-size: 0.65rem; color: var(--muted2); }
.live-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
  animation: pulse 2.5s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.35} }

/* ── MAIN ────────────────────────────────────────────── */
main { max-width: 1200px; margin: 0 auto; padding: 20px; }

/* ── LOADING ─────────────────────────────────────────── */
#loading {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 16px; padding: 80px 0;
}
.spinner {
  width: 36px; height: 36px;
  border: 3px solid var(--border2);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { to{ transform:rotate(360deg) } }
#loading p { font-family: var(--mono); font-size: 0.75rem; color: var(--muted); }

/* ── KPI ROW ─────────────────────────────────────────── */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 10px; margin-bottom: 20px;
}
.kpi-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; padding: 14px 16px;
  cursor: pointer; transition: border-color .15s, background .15s;
  display: flex; flex-direction: column; gap: 4px;
}
.kpi-card:hover { border-color: var(--border2); background: var(--surface2); }
.kpi-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: .6px; }
.kpi-value { font-family: var(--mono); font-size: 1.25rem; font-weight: 600; }
.kpi-sub   { font-family: var(--mono); font-size: 0.65rem; color: var(--muted2); }
.kpi-var   { font-family: var(--mono); font-size: 0.68rem; }

/* ── PANEL ───────────────────────────────────────────── */
.panel {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; overflow: hidden; margin-bottom: 14px;
}
.panel-header {
  padding: 10px 16px; border-bottom: 1px solid var(--border);
  font-family: var(--mono); font-size: 0.72rem;
  color: var(--muted); text-transform: uppercase; letter-spacing: .6px;
  display: flex; align-items: center; gap: 10px;
}

/* ── TABS ────────────────────────────────────────────── */
.tabs {
  display: flex; gap: 4px; padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}
.tab {
  font-family: var(--mono); font-size: 0.72rem;
  color: var(--muted); padding: 4px 12px;
  border-radius: 20px; cursor: pointer;
  border: 1px solid transparent;
  transition: all .15s;
}
.tab:hover  { color: var(--text); border-color: var(--border2); }
.tab.active { color: var(--accent); border-color: var(--accent); background: #1a2a3a; }

/* ── TABLE ───────────────────────────────────────────── */
.tbl-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
th, td { padding: 9px 14px; text-align: right; white-space: nowrap; }
th:first-child, td:first-child { text-align: left; }
thead th {
  font-family: var(--mono); font-size: 0.62rem; color: var(--muted);
  text-transform: uppercase; letter-spacing: .5px;
  border-bottom: 1px solid var(--border);
  cursor: pointer; user-select: none; position: sticky; top: 0;
  background: var(--surface);
}
thead th:hover { color: var(--accent); }
thead th.sort-asc::after  { content: ' ↑'; color: var(--accent); }
thead th.sort-desc::after { content: ' ↓'; color: var(--accent); }
tbody tr {
  border-bottom: 1px solid var(--border);
  cursor: pointer; transition: background .1s;
}
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--surface2); }
.var-dot {
  display: inline-block; width: 8px; height: 8px;
  border-radius: 50%; margin-right: 8px; flex-shrink: 0;
}
.var-name { display: flex; align-items: center; }
.grupo-badge {
  font-family: var(--mono); font-size: 0.58rem;
  color: var(--muted2); padding: 1px 6px;
  border: 1px solid var(--border); border-radius: 3px;
  margin-left: 8px;
}
.pos { color: var(--green); }
.neg { color: var(--red); }
.neu { color: var(--muted); }
.val-mono { font-family: var(--mono); }
.row-arrow { color: var(--muted2); font-size: 0.8rem; padding-left: 4px; }

/* ── MODAL ───────────────────────────────────────────── */
#modal {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(4px);
  align-items: center; justify-content: center;
  padding: 20px;
}
.modal-box {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 12px; width: 100%; max-width: 820px;
  max-height: 90vh; overflow: hidden;
  display: flex; flex-direction: column;
  box-shadow: 0 24px 60px rgba(0,0,0,.6);
}
.modal-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: flex-start; gap: 12px;
}
.modal-color-bar {
  width: 4px; border-radius: 2px; align-self: stretch; flex-shrink: 0;
}
.modal-info { flex: 1; }
.modal-title { font-size: 1rem; font-weight: 600; margin-bottom: 3px; }
.modal-meta  { font-family: var(--mono); font-size: 0.7rem; color: var(--muted); display: flex; gap: 14px; }
.modal-value { font-size: 1.5rem; font-weight: 700; font-family: var(--mono); }
.modal-close {
  background: none; border: 1px solid var(--border);
  color: var(--muted); border-radius: 6px; width: 28px; height: 28px;
  cursor: pointer; font-size: 1rem; display: flex; align-items: center;
  justify-content: center; transition: color .15s, border-color .15s; flex-shrink: 0;
}
.modal-close:hover { color: var(--red); border-color: var(--red); }
.modal-periods {
  display: flex; gap: 4px; padding: 10px 20px;
  border-bottom: 1px solid var(--border);
}
.period-btn {
  font-family: var(--mono); font-size: 0.7rem;
  color: var(--muted); padding: 3px 10px;
  border-radius: 4px; cursor: pointer;
  border: 1px solid transparent; background: none;
  transition: all .15s;
}
.period-btn:hover  { color: var(--text); border-color: var(--border2); }
.period-btn.active { color: var(--accent); border-color: var(--accent); background: #1a2a3a; }
.modal-stats {
  display: flex; gap: 20px; padding: 8px 20px;
  border-bottom: 1px solid var(--border);
  font-family: var(--mono); font-size: 0.68rem;
}
.stat-item { display: flex; flex-direction: column; gap: 1px; }
.stat-label { color: var(--muted2); font-size: 0.6rem; text-transform: uppercase; }
.stat-value { color: var(--text); }
#modal-chart { flex: 1; min-height: 280px; }

/* ── SCROLLBAR ───────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--muted2); }
</style>
</head>
<body>

<!-- TOPBAR -->
<nav class="topbar">
  <a href="../index.html" class="back-link">← Inicio</a>
  <span class="topbar-sep">|</span>
  <span class="topbar-title">▪ BCRA · Monitor Económico</span>
  <div class="topbar-right">
    <span id="timestamp"></span>
    <div class="live-dot"></div>
  </div>
</nav>

<main>
  <div id="loading">
    <div class="spinner"></div>
    <p>Cargando datos del BCRA…</p>
  </div>

  <div id="content" style="display:none">
    <!-- KPI ROW -->
    <div class="kpi-row" id="kpi-row"></div>

    <!-- VARIABLE TABLE -->
    <div class="panel">
      <div class="panel-header">
        Variables macroeconómicas
        <span style="font-size:0.6rem;margin-left:auto">clic en fila para ver gráfico</span>
      </div>
      <div class="tabs" id="tabs"></div>
      <div class="tbl-wrap">
        <table>
          <thead>
            <tr>
              <th onclick="sortTable('nombre')">Variable</th>
              <th onclick="sortTable('grupo')">Grupo</th>
              <th onclick="sortTable('ultimo')">Último</th>
              <th style="min-width:80px">Unidad</th>
              <th onclick="sortTable('ultimo_fecha')">Fecha</th>
              <th onclick="sortTable('var_30d')">Δ 30d</th>
              <th onclick="sortTable('var_1a')">Δ 1 año</th>
              <th style="width:30px"></th>
            </tr>
          </thead>
          <tbody id="tbl-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<!-- MODAL -->
<div id="modal" onclick="handleModalClick(event)">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-color-bar" id="modal-color-bar"></div>
      <div class="modal-info">
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-meta">
          <span id="modal-unidad"></span>
          <span id="modal-fecha"></span>
        </div>
      </div>
      <div class="modal-value" id="modal-value"></div>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div class="modal-periods" id="modal-periods"></div>
    <div class="modal-stats" id="modal-stats"></div>
    <div id="modal-chart"></div>
  </div>
</div>

<script>
// ── helpers ───────────────────────────────────────────────────
const $ = id => document.getElementById(id);

function fmtVal(v, unidad) {
  if (v == null) return '—';
  if (unidad.startsWith('%')) return v.toFixed(2) + '%';
  if (unidad === 'ARS/USD') return v.toLocaleString('es-AR', {minimumFractionDigits:2, maximumFractionDigits:2});
  if (v >= 1e6)  return v.toLocaleString('es-AR', {maximumFractionDigits:0});
  if (v >= 1000) return v.toLocaleString('es-AR', {maximumFractionDigits:1});
  return v.toLocaleString('es-AR', {maximumFractionDigits:2});
}

function fmtPct(v) {
  if (v == null) return { text: '—', cls: 'neu' };
  const sign = v > 0 ? '+' : '';
  return { text: sign + v.toFixed(2) + '%', cls: v > 0 ? 'pos' : v < 0 ? 'neg' : 'neu' };
}

function fmtDate(s) {
  if (!s) return '—';
  const [y, m, d] = s.split('-');
  const months = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
  return `${parseInt(d)} ${months[parseInt(m)-1]} ${y}`;
}

// ── state ────────────────────────────────────────────────────
let DATA        = null;
let activeGroup = 'Todos';
let sortCol     = 'grupo';
let sortDir     = 1;
let modalId     = null;
let modalPeriod = '1A';

const PERIODS = { '1M':30, '3M':90, '6M':180, '1A':365, '2A':730, 'MAX':99999 };
const GROUP_ORDER = ['Tipo de Cambio','Tasas','Inflación','Monetario'];

// ── fetch ────────────────────────────────────────────────────
fetch('data.json?' + Date.now())
  .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
  .then(d => { DATA = d; init(); })
  .catch(err => {
    $('loading').innerHTML = `
      <div style="text-align:center;padding:60px 0">
        <div style="font-family:var(--mono);font-size:0.8rem;color:var(--red)">
          Error al cargar datos<br>
          <span style="color:var(--muted);font-size:0.7rem">${err}</span>
        </div>
      </div>`;
  });

function init() {
  $('loading').style.display  = 'none';
  $('content').style.display  = '';
  $('timestamp').textContent  = DATA.generated_at || '';

  buildKPIs();
  buildTabs();
  buildTable();
}

// ── KPI ──────────────────────────────────────────────────────
function buildKPIs() {
  const ids = DATA.kpi_ids || [1, 4, 27, 28, 160, 7];
  $('kpi-row').innerHTML = ids.map(id => {
    const d = DATA.variables[String(id)];
    if (!d) return '';
    const val   = fmtVal(d.ultimo, d.unidad);
    const v30   = fmtPct(d.var_30d);
    return `<div class="kpi-card" onclick="openModal(${id})">
      <div class="kpi-label">${d.nombre}</div>
      <div class="kpi-value" style="color:${d.color}">${val}</div>
      <div class="kpi-sub">${d.unidad}</div>
      <div class="kpi-var ${v30.cls}">30d: ${v30.text}</div>
    </div>`;
  }).join('');
}

// ── TABS ─────────────────────────────────────────────────────
function buildTabs() {
  const groups = ['Todos', ...GROUP_ORDER];
  $('tabs').innerHTML = groups.map(g => `
    <div class="tab${g === activeGroup ? ' active' : ''}" onclick="setGroup('${g}')">${g}</div>
  `).join('');
}

function setGroup(g) {
  activeGroup = g;
  buildTabs();
  buildTable();
}

// ── TABLE ─────────────────────────────────────────────────────
function buildTable() {
  const all = Object.values(DATA.variables);
  let rows = activeGroup === 'Todos'
    ? all
    : all.filter(d => d.grupo === activeGroup);

  rows.sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (sortCol === 'grupo') {
      va = GROUP_ORDER.indexOf(a.grupo);
      vb = GROUP_ORDER.indexOf(b.grupo);
    }
    if (va == null) return 1;
    if (vb == null) return -1;
    if (typeof va === 'string') return sortDir * va.localeCompare(vb);
    return sortDir * (vb - va);
  });

  // update sort arrows
  document.querySelectorAll('thead th').forEach(th => th.classList.remove('sort-asc','sort-desc'));
  const colMap = ['nombre','grupo','ultimo',null,'ultimo_fecha','var_30d','var_1a'];
  colMap.forEach((col, i) => {
    if (col === sortCol) {
      const th = document.querySelectorAll('thead th')[i];
      if (th) th.classList.add(sortDir === 1 ? 'sort-desc' : 'sort-asc');
    }
  });

  $('tbl-body').innerHTML = rows.map(d => {
    const v30 = fmtPct(d.var_30d);
    const v1a = fmtPct(d.var_1a);
    return `<tr onclick="openModal(${d.id})">
      <td>
        <div class="var-name">
          <span class="var-dot" style="background:${d.color}"></span>
          ${d.nombre}
        </div>
      </td>
      <td style="color:var(--muted2);font-size:0.7rem">${d.grupo}</td>
      <td class="val-mono">${fmtVal(d.ultimo, d.unidad)}</td>
      <td style="color:var(--muted2);font-size:0.7rem">${d.unidad}</td>
      <td class="val-mono" style="color:var(--muted)">${fmtDate(d.ultimo_fecha)}</td>
      <td class="val-mono ${v30.cls}">${v30.text}</td>
      <td class="val-mono ${v1a.cls}">${v1a.text}</td>
      <td class="row-arrow">›</td>
    </tr>`;
  }).join('');
}

function sortTable(col) {
  if (sortCol === col) { sortDir *= -1; }
  else { sortCol = col; sortDir = col === 'nombre' || col === 'grupo' ? 1 : -1; }
  buildTable();
}

// ── MODAL ─────────────────────────────────────────────────────
function openModal(id) {
  modalId     = id;
  modalPeriod = '1A';
  const d = DATA.variables[String(id)];
  if (!d) return;

  // header
  $('modal-color-bar').style.background = d.color;
  $('modal-title').textContent  = d.nombre;
  $('modal-unidad').textContent = d.unidad;
  $('modal-fecha').textContent  = 'al ' + fmtDate(d.ultimo_fecha);
  $('modal-value').textContent  = fmtVal(d.ultimo, d.unidad);
  $('modal-value').style.color  = d.color;

  // period buttons
  $('modal-periods').innerHTML = Object.keys(PERIODS).map(p => `
    <button class="period-btn${p === modalPeriod ? ' active' : ''}"
            onclick="setPeriod('${p}')">${p}</button>
  `).join('');

  $('modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  renderChart();
}

function closeModal() {
  $('modal').style.display = 'none';
  document.body.style.overflow = '';
  Plotly.purge('modal-chart');
}

function handleModalClick(e) {
  if (e.target === $('modal')) closeModal();
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function setPeriod(p) {
  modalPeriod = p;
  document.querySelectorAll('.period-btn').forEach(b => {
    b.classList.toggle('active', b.textContent === p);
  });
  renderChart();
}

function renderChart() {
  const d = DATA.variables[String(modalId)];
  if (!d) return;

  const days   = PERIODS[modalPeriod];
  const cutoff = new Date(Date.now() - days * 86400000);

  const pairs    = d.fechas.map((f, i) => [new Date(f), d.valores[i]]);
  const filtered = pairs.filter(([dt]) => dt >= cutoff);

  if (!filtered.length) {
    $('modal-chart').innerHTML = `<div style="padding:40px;text-align:center;font-family:var(--mono);font-size:0.75rem;color:var(--muted)">Sin datos para este período</div>`;
    $('modal-stats').innerHTML = '';
    return;
  }

  const xs = filtered.map(([dt]) => dt);
  const ys = filtered.map(([, v]) => v);

  // stats for the period
  const min    = Math.min(...ys);
  const max    = Math.max(...ys);
  const first  = ys[0];
  const last   = ys[ys.length - 1];
  const varPct = first !== 0 ? ((last - first) / Math.abs(first) * 100) : null;
  const vp     = fmtPct(varPct);

  $('modal-stats').innerHTML = `
    <div class="stat-item"><div class="stat-label">Mínimo</div><div class="stat-value">${fmtVal(min, d.unidad)}</div></div>
    <div class="stat-item"><div class="stat-label">Máximo</div><div class="stat-value">${fmtVal(max, d.unidad)}</div></div>
    <div class="stat-item"><div class="stat-label">Inicio período</div><div class="stat-value">${fmtVal(first, d.unidad)}</div></div>
    <div class="stat-item"><div class="stat-label">Variación período</div><div class="stat-value ${vp.cls}">${vp.text}</div></div>
    <div class="stat-item"><div class="stat-label">Puntos de datos</div><div class="stat-value">${filtered.length}</div></div>
  `;

  const isBar = d.unidad.startsWith('%') && d.grupo === 'Inflación';

  const trace = isBar ? {
    x: xs, y: ys, type: 'bar',
    marker: { color: ys.map(v => v >= 0 ? d.color : '#f85149'), opacity: 0.8 },
    hovertemplate: '%{x|%d/%m/%Y}<br><b>%{y:.2f}%</b><extra></extra>',
  } : {
    x: xs, y: ys, type: 'scatter', mode: 'lines',
    fill: 'tozeroy',
    fillcolor: d.color + '18',
    line: { color: d.color, width: 1.8, shape: 'linear' },
    hovertemplate: '%{x|%d/%m/%Y}<br><b>%{y:,.2f}</b> ' + d.unidad + '<extra></extra>',
  };

  Plotly.react('modal-chart', [trace], {
    paper_bgcolor: 'transparent',
    plot_bgcolor:  'transparent',
    margin: { t: 12, r: 16, b: 44, l: 60 },
    xaxis: {
      gridcolor: '#21262d', zerolinecolor: '#30363d',
      tickfont: { family: 'IBM Plex Mono', size: 9, color: '#8b949e' },
      type: 'date',
    },
    yaxis: {
      gridcolor: '#21262d',
      tickfont: { family: 'IBM Plex Mono', size: 9, color: '#8b949e' },
      tickformat: d.unidad.startsWith('%') ? '.2f' : ',.0f',
      ticksuffix: d.unidad.startsWith('%') ? '%' : '',
    },
    hoverlabel: {
      bgcolor: '#1c2128', bordercolor: '#30363d',
      font: { family: 'IBM Plex Mono', size: 11, color: '#e6edf3' },
    },
    font: { family: 'IBM Plex Mono', color: '#e6edf3' },
  }, { responsive: true, displayModeBar: false });
}
</script>
</body>
</html>
