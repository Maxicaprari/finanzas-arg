<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S&P 500 · Mercado Internacional</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    :root {
      --bg:      #0a0d12;
      --surface: #111318;
      --surface2:#161b22;
      --surface3:#1c2128;
      --border:  #21262d;
      --border2: #30363d;
      --text:    #e6edf3;
      --muted:   #8b949e;
      --muted2:  #6e7681;
      --accent:  #58a6ff;
      --green:   #3fb950;
      --red:     #f85149;
      --yellow:  #d29922;
      --mono:    'IBM Plex Mono', monospace;
      --sans:    'IBM Plex Sans', sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ── TOPBAR ─────────────────────────────────────────── */
    .topbar {
      position: sticky; top: 0; z-index: 100;
      background: rgba(10,13,18,.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      height: 48px;
      display: flex; align-items: center; gap: 12px;
    }
    .topbar-left { display: flex; align-items: center; gap: 12px; flex: 1; }
    .back-link {
      font-family: var(--mono); font-size: 0.72rem;
      color: var(--muted); text-decoration: none;
      padding: 3px 8px; border-radius: 4px;
      border: 1px solid var(--border);
      transition: color .15s, border-color .15s;
    }
    .back-link:hover { color: var(--accent); border-color: var(--accent); }
    .topbar-title {
      font-family: var(--mono); font-size: 0.85rem;
      font-weight: 600; color: var(--text); letter-spacing: .5px;
    }
    .topbar-sep { color: var(--border2); font-size: 0.8rem; }
    #sentiment-badge {
      font-family: var(--mono); font-size: 0.7rem; font-weight: 600;
      padding: 2px 8px; border-radius: 20px;
      background: #1c2128; color: var(--muted);
      border: 1px solid var(--border2);
    }
    .topbar-right { display: flex; align-items: center; gap: 10px; }
    #timestamp { font-family: var(--mono); font-size: 0.65rem; color: var(--muted2); }

    /* search */
    .search-wrap { position: relative; }
    #search-input {
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); font-family: var(--mono); font-size: 0.75rem;
      padding: 4px 10px; border-radius: 6px; width: 160px;
      outline: none; transition: border-color .15s;
    }
    #search-input:focus { border-color: var(--accent); }
    #search-dropdown {
      display: none; position: absolute; top: calc(100% + 4px); right: 0;
      width: 280px; background: var(--surface2);
      border: 1px solid var(--border2); border-radius: 6px;
      max-height: 260px; overflow-y: auto; z-index: 200;
    }
    .search-item {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 10px; cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .search-item:last-child { border-bottom: none; }
    .search-item:hover { background: var(--surface3); }
    .search-ticker { font-family: var(--mono); font-size: 0.72rem; color: var(--accent); min-width: 50px; }
    .search-name { font-size: 0.72rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .search-chg { font-family: var(--mono); font-size: 0.72rem; margin-left: auto; }

    /* ── MAIN ────────────────────────────────────────────── */
    main { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* ── LOADING ─────────────────────────────────────────── */
    #loading {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; gap: 16px; padding: 80px 0;
    }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading p { font-family: var(--mono); font-size: 0.75rem; color: var(--muted); }

    /* ── KPI ROW ─────────────────────────────────────────── */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px; margin-bottom: 18px;
    }
    .kpi-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px 14px;
      display: flex; flex-direction: column; gap: 4px;
    }
    .kpi-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: .6px; }
    .kpi-value { font-family: var(--mono); font-size: 1.3rem; font-weight: 600; }
    .kpi-sub { font-family: var(--mono); font-size: 0.65rem; color: var(--muted2); }

    /* ── SUMMARY ─────────────────────────────────────────── */
    .summary-card {
      background: var(--surface); border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      border-radius: 8px; padding: 14px 18px;
      font-size: 0.82rem; color: var(--muted);
      line-height: 1.7; margin-bottom: 18px;
    }
    .summary-card strong { color: var(--text); }

    /* ── BREADTH BAR ─────────────────────────────────────── */
    .breadth-wrap { margin-bottom: 18px; }
    .breadth-label {
      font-family: var(--mono); font-size: 0.65rem;
      color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .6px;
    }
    .breadth-bar {
      display: flex; height: 18px; border-radius: 4px; overflow: hidden;
      border: 1px solid var(--border);
    }
    .b-up   { background: var(--green); transition: width .5s; }
    .b-down { background: var(--red);   transition: width .5s; }
    .b-flat { background: var(--muted2); transition: width .5s; }
    .breadth-legend {
      display: flex; gap: 18px; margin-top: 5px;
      font-family: var(--mono); font-size: 0.65rem; color: var(--muted);
    }
    .breadth-legend span::before {
      content: '▪ ';
    }
    .bl-up::before   { color: var(--green) !important; }
    .bl-down::before { color: var(--red) !important; }
    .bl-flat::before { color: var(--muted2) !important; }

    /* ── TWO-COL LAYOUT ──────────────────────────────────── */
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 18px; }
    @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

    /* ── SECTOR HEATMAP ──────────────────────────────────── */
    .panel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; overflow: hidden;
    }
    .panel-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-family: var(--mono); font-size: 0.72rem;
      color: var(--muted); text-transform: uppercase; letter-spacing: .6px;
      display: flex; align-items: center; justify-content: space-between;
    }
    #sector-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px; padding: 12px;
    }
    .sector-cell {
      border-radius: 6px; padding: 8px 10px;
      cursor: pointer; transition: opacity .15s, transform .15s;
      border: 2px solid transparent;
      display: flex; flex-direction: column; gap: 3px;
    }
    .sector-cell:hover { opacity: .85; transform: scale(1.02); }
    .sector-cell.active { border-color: var(--text) !important; }
    .sc-name { font-size: 0.65rem; font-weight: 500; line-height: 1.3; }
    .sc-pct  { font-family: var(--mono); font-size: 0.9rem; font-weight: 600; }
    .sc-meta { font-family: var(--mono); font-size: 0.6rem; opacity: .75; }

    /* ── HISTOGRAM ───────────────────────────────────────── */
    #histogram { height: 240px; }

    /* ── ACTIVE SECTOR PILL ──────────────────────────────── */
    #active-sector-bar {
      display: none; align-items: center; gap: 10px;
      margin-bottom: 12px;
      padding: 6px 12px; background: var(--surface2);
      border: 1px solid var(--border2); border-radius: 6px;
    }
    #active-sector-bar span { font-size: 0.78rem; color: var(--muted); }
    #active-sector-name { font-family: var(--mono); font-size: 0.78rem; color: var(--accent); font-weight: 600; }
    #clear-sector {
      margin-left: auto; font-family: var(--mono); font-size: 0.7rem;
      color: var(--muted); cursor: pointer; padding: 2px 8px;
      border: 1px solid var(--border2); border-radius: 4px;
      background: none; transition: color .15s;
    }
    #clear-sector:hover { color: var(--red); border-color: var(--red); }

    /* ── TABLES ROW ──────────────────────────────────────── */
    .tables-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 18px; }
    @media (max-width: 900px) { .tables-row { grid-template-columns: 1fr; } }

    /* ── TABLE PANELS ────────────────────────────────────── */
    .tbl-wrap { overflow-x: auto; }
    table {
      width: 100%; border-collapse: collapse;
      font-size: 0.75rem;
    }
    th, td { padding: 6px 10px; text-align: right; white-space: nowrap; }
    th:first-child, td:first-child { text-align: left; }
    thead th {
      font-family: var(--mono); font-size: 0.62rem;
      color: var(--muted); text-transform: uppercase; letter-spacing: .5px;
      border-bottom: 1px solid var(--border);
      cursor: pointer; user-select: none;
    }
    thead th:hover { color: var(--accent); }
    thead th.sort-asc::after  { content: ' ↑'; color: var(--accent); }
    thead th.sort-desc::after { content: ' ↓'; color: var(--accent); }
    tbody tr { border-bottom: 1px solid var(--border); transition: background .1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }
    .ticker-sym { font-family: var(--mono); color: var(--accent); font-size: 0.72rem; }
    .pos { color: var(--green); }
    .neg { color: var(--red); }
    .neu { color: var(--muted); }

    /* ── VOLUME OUTLIERS ─────────────────────────────────── */
    #vol-section { margin-bottom: 18px; display: none; }
    .vol-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 0; }
    .vol-layout .tbl-wrap { border-right: 1px solid var(--border); }
    #vol-chart { height: 320px; }
    @media (max-width: 900px) { .vol-layout { grid-template-columns: 1fr; } }

    /* ── FULL PANEL ──────────────────────────────────────── */
    #full-panel { margin-bottom: 24px; }
    .panel-controls {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 12px; border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    #full-search {
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); font-family: var(--mono); font-size: 0.72rem;
      padding: 4px 10px; border-radius: 5px; width: 180px; outline: none;
    }
    #full-search:focus { border-color: var(--accent); }
    .count-badge {
      font-family: var(--mono); font-size: 0.65rem;
      color: var(--muted); margin-left: auto;
    }

    /* ── SCROLLBAR ───────────────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted2); }
  </style>
</head>
<body>

<!-- TOPBAR -->
<nav class="topbar">
  <div class="topbar-left">
    <a href="../index.html" class="back-link">← Inicio</a>
    <span class="topbar-sep">|</span>
    <span class="topbar-title">▪ S&P 500</span>
    <span id="sentiment-badge">cargando…</span>
  </div>
  <div class="topbar-right">
    <span id="timestamp"></span>
    <div class="search-wrap">
      <input id="search-input" type="text" placeholder="Buscar ticker…" autocomplete="off">
      <div id="search-dropdown"></div>
    </div>
  </div>
</nav>

<main>
  <!-- LOADING -->
  <div id="loading">
    <div class="spinner"></div>
    <p>Cargando datos del mercado…</p>
  </div>

  <!-- CONTENT (hidden until data loads) -->
  <div id="content" style="display:none">

    <!-- KPI ROW -->
    <div class="kpi-row" id="kpi-row"></div>

    <!-- SUMMARY -->
    <div class="summary-card" id="summary-card"></div>

    <!-- BREADTH BAR -->
    <div class="breadth-wrap">
      <div class="breadth-label">Amplitud de mercado</div>
      <div class="breadth-bar">
        <div class="b-up"   id="b-up"   style="width:0%"></div>
        <div class="b-flat" id="b-flat" style="width:0%"></div>
        <div class="b-down" id="b-down" style="width:0%"></div>
      </div>
      <div class="breadth-legend">
        <span class="bl-up"   id="bl-up-label"></span>
        <span class="bl-flat" id="bl-flat-label"></span>
        <span class="bl-down" id="bl-down-label"></span>
      </div>
    </div>

    <!-- HEATMAP + HISTOGRAM -->
    <div class="two-col" style="margin-bottom:18px">
      <div class="panel">
        <div class="panel-header">
          Sectores por rendimiento promedio
          <span style="font-size:0.6rem">clic para filtrar</span>
        </div>
        <div id="sector-grid"></div>
      </div>
      <div class="panel">
        <div class="panel-header">Distribución de cambios (%)</div>
        <div id="histogram"></div>
      </div>
    </div>

    <!-- ACTIVE SECTOR BAR -->
    <div id="active-sector-bar">
      <span>Filtrando por sector:</span>
      <span id="active-sector-name"></span>
      <button id="clear-sector" onclick="clearSector()">× limpiar</button>
    </div>

    <!-- TOP GAINERS / LOSERS -->
    <div class="tables-row">
      <div class="panel">
        <div class="panel-header">Top 20 alzas</div>
        <div class="tbl-wrap">
          <table id="tbl-gainers"><thead><tr>
            <th>Ticker</th><th>Nombre</th><th>Sector</th><th>%</th><th>Precio</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">Top 20 bajas</div>
        <div class="tbl-wrap">
          <table id="tbl-losers"><thead><tr>
            <th>Ticker</th><th>Nombre</th><th>Sector</th><th>%</th><th>Precio</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- VOLUME OUTLIERS -->
    <div id="vol-section" class="panel">
      <div class="panel-header">
        Volumen inusual (≥2× promedio 30 ruedas)
        <span style="font-size:0.6rem">tamaño = volumen absoluto · eje Y = múltiplo del promedio</span>
      </div>
      <div class="vol-layout">
        <div class="tbl-wrap" style="max-height:320px;overflow-y:auto">
          <table id="tbl-vol"><thead><tr>
            <th>Ticker</th><th>Nombre</th><th>%</th>
            <th>Vol×</th><th>Precio</th>
          </tr></thead><tbody></tbody></table>
        </div>
        <div id="vol-chart"></div>
      </div>
    </div>

    <!-- FULL TABLE -->
    <div class="panel" id="full-panel">
      <div class="panel-header">
        Universo completo
        <span id="full-count" class="count-badge"></span>
      </div>
      <div class="panel-controls">
        <input id="full-search" type="text" placeholder="Buscar por ticker o nombre…" oninput="filterFull()">
      </div>
      <div class="tbl-wrap" style="max-height:420px;overflow-y:auto">
        <table id="tbl-full">
          <thead><tr>
            <th onclick="sortFull('ticker')">Ticker</th>
            <th onclick="sortFull('name')">Nombre</th>
            <th onclick="sortFull('sector')">Sector</th>
            <th onclick="sortFull('change_pct')">%</th>
            <th onclick="sortFull('price')">Precio</th>
            <th onclick="sortFull('vol_ratio')">Vol×</th>
            <th onclick="sortFull('market_cap')">Mkt Cap</th>
          </tr></thead>
          <tbody id="tbl-full-body"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /content -->
</main>

<script>
// ── helpers ────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const fmt = (n, d=2) => n == null ? '—' : Number(n).toFixed(d);
const fmtB = n => {
  if (n == null) return '—';
  if (n >= 1e12) return '$' + (n/1e12).toFixed(2) + 'T';
  if (n >= 1e9)  return '$' + (n/1e9).toFixed(2) + 'B';
  if (n >= 1e6)  return '$' + (n/1e6).toFixed(1) + 'M';
  return '$' + n.toFixed(0);
};
const fmtVol = n => {
  if (n == null) return '—';
  if (n >= 1e9) return (n/1e9).toFixed(2) + 'B';
  if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n/1e3).toFixed(0) + 'K';
  return n.toString();
};
const chgClass = v => v > 0 ? 'pos' : v < 0 ? 'neg' : 'neu';
const chgSign  = v => (v > 0 ? '+' : '') + fmt(v) + '%';

// heatmap color scale: red → grey → green
function heatColor(pct) {
  const p = Math.max(-4, Math.min(4, pct));
  if (p >= 0) {
    const t = p / 4;
    const r = Math.round(31  + t*(63  - 31));
    const g = Math.round(185 + t*(185 - 185));
    const b = Math.round(80  + t*(80  - 80));
    // green: #3fb950 = rgb(63,185,80)
    const R = Math.round(28  * (1-t) + 63  * t);
    const G = Math.round(33  * (1-t) + 185 * t);
    const B = Math.round(40  * (1-t) + 80  * t);
    return `rgb(${R},${G},${B})`;
  } else {
    const t = (-p) / 4;
    const R = Math.round(28  * (1-t) + 248 * t);
    const G = Math.round(33  * (1-t) + 81  * t);
    const B = Math.round(40  * (1-t) + 73  * t);
    return `rgb(${R},${G},${B})`;
  }
}
function textColor(pct) {
  return Math.abs(pct) > 1.5 ? '#ffffff' : '#e6edf3';
}

// ── state ──────────────────────────────────────────────────
let DATA = null;
let activeSector = null;
let fullSortCol  = 'change_pct';
let fullSortDir  = -1; // -1 desc, 1 asc
let fullFiltered = [];

// ── fetch & init ────────────────────────────────────────────
fetch('data.json?' + Date.now())
  .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
  .then(d => { DATA = d; init(); })
  .catch(err => {
    $('loading').innerHTML = `
      <div style="text-align:center;padding:60px 0">
        <div style="font-family:var(--mono);font-size:0.8rem;color:var(--red)">
          Error al cargar datos<br>
          <span style="color:var(--muted);font-size:0.7rem">${err}</span>
        </div>
      </div>`;
  });

function init() {
  $('loading').style.display = 'none';
  $('content').style.display = '';

  const ms = DATA.market_summary;

  // timestamp
  $('timestamp').textContent = ms.generated_at || DATA.generated_at || '';

  // sentiment badge
  const badge = $('sentiment-badge');
  badge.textContent = ms.sentiment;
  badge.style.background = ms.sentiment_color + '22';
  badge.style.color = ms.sentiment_color;
  badge.style.borderColor = ms.sentiment_color + '55';

  buildKPI(ms);
  buildSummary(ms);
  buildBreadth(ms);
  buildSectorGrid(DATA.sectors);
  buildHistogram(DATA.changes);
  buildGainersLosers(DATA.tickers);
  buildVolOutliers(DATA.volume_outliers || []);
  buildFull(DATA.tickers);
  initSearch(DATA.tickers);
}

// ── KPI ─────────────────────────────────────────────────────
function buildKPI(ms) {
  const items = [
    { label: 'Universo',   value: ms.total_stocks, sub: 'acciones S&P 500',  color: 'var(--accent)' },
    { label: 'Alcistas',   value: ms.advances,      sub: `${fmt(ms.advances/ms.total_stocks*100,1)}%`, color: 'var(--green)' },
    { label: 'Bajistas',   value: ms.declines,      sub: `${fmt(ms.declines/ms.total_stocks*100,1)}%`, color: 'var(--red)' },
    { label: 'Ratio A/D',  value: fmt(ms.ad_ratio), sub: ms.advances + ' / ' + ms.declines, color: ms.ad_ratio >= 1 ? 'var(--green)' : 'var(--red)' },
    { label: 'Promedio',   value: chgSign(ms.avg_change), sub: 'cambio medio', color: ms.avg_change >= 0 ? 'var(--green)' : 'var(--red)' },
    { label: 'Desvío σ',   value: fmt(ms.std_change) + '%', sub: ms.std_change > 2 ? 'alta dispersión' : 'dispersión normal', color: 'var(--yellow)' },
  ];
  $('kpi-row').innerHTML = items.map(i => `
    <div class="kpi-card">
      <div class="kpi-label">${i.label}</div>
      <div class="kpi-value" style="color:${i.color}">${i.value}</div>
      <div class="kpi-sub">${i.sub}</div>
    </div>`).join('');
}

// ── SUMMARY ─────────────────────────────────────────────────
function buildSummary(ms) {
  $('summary-card').innerHTML = ms.executive_summary || '';
}

// ── BREADTH BAR ─────────────────────────────────────────────
function buildBreadth(ms) {
  const total = ms.total_stocks;
  const upPct   = ms.advances  / total * 100;
  const downPct = ms.declines  / total * 100;
  const flatPct = ms.unchanged / total * 100;
  $('b-up').style.width   = upPct   + '%';
  $('b-flat').style.width = flatPct + '%';
  $('b-down').style.width = downPct + '%';
  $('bl-up-label').textContent   = `Alza ${ms.advances} (${fmt(upPct,1)}%)`;
  $('bl-flat-label').textContent = `Sin cambio ${ms.unchanged} (${fmt(flatPct,1)}%)`;
  $('bl-down-label').textContent = `Baja ${ms.declines} (${fmt(downPct,1)}%)`;
}

// ── SECTOR HEATMAP ───────────────────────────────────────────
function buildSectorGrid(sectors) {
  const grid = $('sector-grid');
  grid.innerHTML = sectors.map(s => {
    const bg  = heatColor(s.avg_change);
    const fg  = textColor(s.avg_change);
    const adRatio = s.declines > 0 ? (s.advances/s.declines).toFixed(1) : '∞';
    return `<div class="sector-cell" id="sc-${slugify(s.sector)}"
               style="background:${bg};color:${fg}"
               onclick="toggleSector('${escQ(s.sector)}')">
      <div class="sc-name">${s.sector}</div>
      <div class="sc-pct">${s.avg_change >= 0 ? '+' : ''}${fmt(s.avg_change)}%</div>
      <div class="sc-meta">${s.count} acc · A/D ${adRatio}</div>
    </div>`;
  }).join('');
}

function slugify(s) { return s.replace(/[^a-z0-9]/gi,'_').toLowerCase(); }
function escQ(s)    { return s.replace(/'/g,"\\'"); }

// ── HISTOGRAM ────────────────────────────────────────────────
function buildHistogram(changes) {
  if (!changes || !changes.length) return;
  const mean   = changes.reduce((a,b)=>a+b,0) / changes.length;
  const sorted = [...changes].sort((a,b)=>a-b);
  const median = sorted[Math.floor(sorted.length/2)];

  Plotly.newPlot('histogram', [{
    x: changes, type: 'histogram', nbinsx: 50,
    marker: { color: '#58a6ff', opacity: 0.7 },
    hovertemplate: 'Rango %{x:.2f}%<br>%{y} acciones<extra></extra>'
  }], {
    paper_bgcolor: 'transparent', plot_bgcolor:  'transparent',
    margin: { t: 10, r: 10, b: 30, l: 36 },
    xaxis: {
      gridcolor: '#21262d', zerolinecolor: '#30363d',
      tickfont: { family: 'IBM Plex Mono', size: 9, color: '#8b949e' },
      ticksuffix: '%',
    },
    yaxis: {
      gridcolor: '#21262d',
      tickfont: { family: 'IBM Plex Mono', size: 9, color: '#8b949e' },
    },
    shapes: [
      { type:'line', x0:mean,   x1:mean,   y0:0, y1:1, yref:'paper',
        line:{ color:'#3fb950', width:1.5, dash:'dot' } },
      { type:'line', x0:median, x1:median, y0:0, y1:1, yref:'paper',
        line:{ color:'#d29922', width:1.5, dash:'dot' } },
    ],
    annotations: [
      { x:mean,   yref:'paper', y:0.97, text:`μ ${fmt(mean)}%`, showarrow:false,
        font:{family:'IBM Plex Mono',size:9,color:'#3fb950'}, xanchor:'left' },
      { x:median, yref:'paper', y:0.88, text:`med ${fmt(median)}%`, showarrow:false,
        font:{family:'IBM Plex Mono',size:9,color:'#d29922'}, xanchor:'left' },
    ],
    font: { family: 'IBM Plex Mono', color: '#e6edf3' },
  }, { responsive: true, displayModeBar: false });
}

// ── GAINERS / LOSERS ─────────────────────────────────────────
function buildGainersLosers(tickers) {
  const filtered = activeSector
    ? tickers.filter(t => t.sector === activeSector)
    : tickers;

  const sorted  = [...filtered].sort((a,b) => b.change_pct - a.change_pct);
  const gainers = sorted.slice(0, 20);
  const losers  = sorted.slice(-20).reverse();

  const row = (t, cls) => `<tr>
    <td><span class="ticker-sym">${t.ticker}</span></td>
    <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis">${t.name}</td>
    <td style="color:var(--muted);font-size:0.68rem">${t.sector}</td>
    <td class="${cls}">${chgSign(t.change_pct)}</td>
    <td style="font-family:var(--mono)">${t.price != null ? '$'+fmt(t.price) : '—'}</td>
  </tr>`;

  document.querySelector('#tbl-gainers tbody').innerHTML = gainers.map(t => row(t,'pos')).join('');
  document.querySelector('#tbl-losers tbody').innerHTML  = losers.map(t  => row(t,'neg')).join('');
}

// ── VOLUME OUTLIERS ──────────────────────────────────────────
function buildVolOutliers(outliers) {
  if (!outliers.length) { $('vol-section').style.display = 'none'; return; }
  $('vol-section').style.display = '';

  // tabla compacta
  document.querySelector('#tbl-vol tbody').innerHTML = outliers.map(o => `<tr>
    <td><span class="ticker-sym">${o.ticker}</span></td>
    <td style="max-width:90px;overflow:hidden;text-overflow:ellipsis;color:var(--muted)">${o.name}</td>
    <td class="${chgClass(o.change_pct)}" style="font-family:var(--mono)">${chgSign(o.change_pct)}</td>
    <td style="font-family:var(--mono);color:var(--yellow)">${fmt(o.vol_ratio)}×</td>
    <td style="font-family:var(--mono)">${o.price != null ? '$'+fmt(o.price) : '—'}</td>
  </tr>`).join('');

  // bubble chart: x=change_pct, y=vol_ratio, size=volume
  const colors = outliers.map(o => o.change_pct > 0 ? '#3fb950' : o.change_pct < 0 ? '#f85149' : '#8b949e');
  const sizeRef = Math.max(...outliers.map(o => o.volume)) / 1200;

  Plotly.newPlot('vol-chart', [{
    type: 'scatter',
    mode: 'markers+text',
    x: outliers.map(o => o.change_pct),
    y: outliers.map(o => o.vol_ratio),
    text: outliers.map(o => o.ticker),
    textposition: 'top center',
    textfont: { family: 'IBM Plex Mono', size: 9, color: '#e6edf3' },
    marker: {
      size: outliers.map(o => o.volume),
      sizemode: 'area',
      sizeref: sizeRef,
      sizemin: 8,
      color: colors,
      opacity: 0.75,
      line: { color: '#ffffff22', width: 1 },
    },
    customdata: outliers.map(o => [o.name, o.sector, o.vol_avg_30d, o.volume]),
    hovertemplate:
      '<b>%{text}</b> — %{customdata[0]}<br>' +
      'Sector: %{customdata[1]}<br>' +
      'Cambio: %{x:+.2f}%<br>' +
      'Volumen: %{customdata[3]:,.0f}<br>' +
      'Prom 30d: %{customdata[2]:,.0f}<br>' +
      'Ratio: %{y:.2f}×<extra></extra>',
  }], {
    paper_bgcolor: 'transparent',
    plot_bgcolor:  'transparent',
    margin: { t: 14, r: 14, b: 40, l: 46 },
    xaxis: {
      title: { text: 'Cambio %', font: { family:'IBM Plex Mono', size:9, color:'#8b949e' } },
      gridcolor: '#21262d', zerolinecolor: '#30363d', zerolinewidth: 1.5,
      tickfont: { family:'IBM Plex Mono', size:9, color:'#8b949e' },
      ticksuffix: '%',
    },
    yaxis: {
      title: { text: 'Ratio vol / prom', font: { family:'IBM Plex Mono', size:9, color:'#8b949e' } },
      gridcolor: '#21262d',
      tickfont: { family:'IBM Plex Mono', size:9, color:'#8b949e' },
      ticksuffix: '×',
    },
    shapes: [{
      type: 'line', x0: 0, x1: 0, y0: 0, y1: 1, yref: 'paper',
      line: { color: '#30363d', width: 1, dash: 'dot' }
    }],
    font: { family: 'IBM Plex Mono', color: '#e6edf3' },
  }, { responsive: true, displayModeBar: false });
}

// ── FULL TABLE ───────────────────────────────────────────────
function buildFull(tickers) {
  const query = ($('full-search').value || '').toLowerCase();
  const base  = activeSector ? tickers.filter(t => t.sector === activeSector) : tickers;
  fullFiltered = base.filter(t =>
    !query ||
    t.ticker.toLowerCase().includes(query) ||
    t.name.toLowerCase().includes(query)
  );
  fullFiltered.sort((a,b) => {
    const va = a[fullSortCol] ?? -Infinity;
    const vb = b[fullSortCol] ?? -Infinity;
    return fullSortDir * (typeof va === 'string' ? va.localeCompare(vb) : vb - va);
  });

  // update header arrows
  document.querySelectorAll('#tbl-full thead th').forEach(th => {
    th.classList.remove('sort-asc','sort-desc');
  });
  const colMap = ['ticker','name','sector','change_pct','price','vol_ratio','market_cap'];
  document.querySelectorAll('#tbl-full thead th').forEach((th,i) => {
    if (colMap[i] === fullSortCol) {
      th.classList.add(fullSortDir === 1 ? 'sort-asc' : 'sort-desc');
    }
  });

  $('full-count').textContent = `${fullFiltered.length} acciones`;

  $('tbl-full-body').innerHTML = fullFiltered.map(t => `<tr>
    <td><span class="ticker-sym">${t.ticker}</span></td>
    <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;color:var(--muted)">${t.name}</td>
    <td style="color:var(--muted2);font-size:0.68rem">${t.sector}</td>
    <td class="${chgClass(t.change_pct)}" style="font-family:var(--mono)">${chgSign(t.change_pct)}</td>
    <td style="font-family:var(--mono)">${t.price != null ? '$'+fmt(t.price) : '—'}</td>
    <td style="font-family:var(--mono);color:${t.vol_ratio >= 2 ? 'var(--yellow)' : 'var(--muted)'}">${t.vol_ratio != null ? fmt(t.vol_ratio)+'×' : '—'}</td>
    <td style="font-family:var(--mono);color:var(--muted)">${fmtB(t.market_cap)}</td>
  </tr>`).join('');
}

function filterFull() { buildFull(DATA.tickers); }

function sortFull(col) {
  if (fullSortCol === col) { fullSortDir *= -1; }
  else { fullSortCol = col; fullSortDir = col === 'name' || col === 'ticker' || col === 'sector' ? 1 : -1; }
  buildFull(DATA.tickers);
}

// ── SECTOR FILTER ────────────────────────────────────────────
function toggleSector(sector) {
  if (activeSector === sector) { clearSector(); return; }
  activeSector = sector;

  // highlight cell
  document.querySelectorAll('.sector-cell').forEach(el => el.classList.remove('active'));
  const cell = document.getElementById('sc-' + slugify(sector));
  if (cell) cell.classList.add('active');

  $('active-sector-name').textContent = sector;
  $('active-sector-bar').style.display = 'flex';

  buildGainersLosers(DATA.tickers);
  buildFull(DATA.tickers);
}

function clearSector() {
  activeSector = null;
  document.querySelectorAll('.sector-cell').forEach(el => el.classList.remove('active'));
  $('active-sector-bar').style.display = 'none';
  buildGainersLosers(DATA.tickers);
  buildFull(DATA.tickers);
}

// ── SEARCH ───────────────────────────────────────────────────
function initSearch(tickers) {
  const input = $('search-input');
  const dd    = $('search-dropdown');

  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    if (q.length < 1) { dd.style.display = 'none'; return; }
    const matches = tickers
      .filter(t => t.ticker.toLowerCase().startsWith(q) || t.name.toLowerCase().includes(q))
      .slice(0, 12);
    if (!matches.length) { dd.style.display = 'none'; return; }
    dd.innerHTML = matches.map(t => `
      <div class="search-item" onclick="scrollToTicker('${t.ticker}')">
        <span class="search-ticker">${t.ticker}</span>
        <span class="search-name">${t.name}</span>
        <span class="search-chg ${chgClass(t.change_pct)}">${chgSign(t.change_pct)}</span>
      </div>`).join('');
    dd.style.display = 'block';
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.search-wrap')) dd.style.display = 'none';
  });
}

function scrollToTicker(ticker) {
  $('search-dropdown').style.display = 'none';
  $('search-input').value = ticker;
  // filter full table and scroll to it
  $('full-search').value = ticker;
  filterFull();
  $('full-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>
</body>
</html>
