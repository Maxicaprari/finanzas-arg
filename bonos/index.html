<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bonos ARG ¬∑ Mercado</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
:root {
  --bg: #0a0d12;
  --surface: #111520;
  --surface2: #161b26;
  --border: #1e2535;
  --border2: #252d40;
  --text: #e2e8f0;
  --muted: #5a6a85;
  --muted2: #8899aa;
  --accent: #3b82f6;
  --accent2: #1d4ed8;
  --green: #22c55e;
  --red: #ef4444;
  --yellow: #f59e0b;
  --mono: 'IBM Plex Mono', monospace;
  --sans: 'IBM Plex Sans', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.6;
}

/* TOPBAR */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(10,13,18,0.92);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  display: flex; align-items: center; gap: 20px;
  height: 52px;
}
.topbar-logo {
  font-family: var(--mono); font-size: 0.85rem; font-weight: 600;
  color: var(--accent); letter-spacing: 0.1em; text-transform: uppercase;
  white-space: nowrap;
}
.topbar-sep { width: 1px; height: 20px; background: var(--border2); }
.topbar-sentiment {
  font-family: var(--mono); font-size: 0.75rem;
  padding: 3px 10px; border-radius: 4px;
  border: 1px solid; white-space: nowrap;
}
.topbar-meta {
  margin-left: auto; font-family: var(--mono); font-size: 0.7rem; color: var(--muted);
  white-space: nowrap;
}
.topbar-search {
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 6px; padding: 5px 12px;
  color: var(--text); font-family: var(--mono); font-size: 0.78rem;
  width: 160px; outline: none;
  transition: border-color 0.2s, width 0.3s;
}
.topbar-search:focus { border-color: var(--accent); width: 220px; }
.topbar-search::placeholder { color: var(--muted); }

/* LAYOUT */
.wrap { max-width: 1440px; margin: 0 auto; padding: 28px 28px 80px; }

/* KPI ROW */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px; margin-bottom: 24px;
}
.kpi {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; padding: 16px 18px;
  transition: border-color 0.2s;
}
.kpi:hover { border-color: var(--border2); }
.kpi-label {
  font-family: var(--mono); font-size: 0.65rem; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--muted); margin-bottom: 8px;
}
.kpi-val {
  font-family: var(--mono); font-size: 1.6rem; font-weight: 600; line-height: 1;
}
.kpi-val.pos { color: var(--green); }
.kpi-val.neg { color: var(--red); }
.kpi-val.neu { color: var(--text); }
.kpi-val.acc { color: var(--accent); }

/* SUMMARY */
.summary {
  background: var(--surface); border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  border-radius: 8px; padding: 16px 20px; margin-bottom: 24px;
  font-size: 0.85rem; color: var(--muted2); line-height: 1.7;
}
.summary-label {
  font-family: var(--mono); font-size: 0.65rem; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--accent); margin-bottom: 8px;
}

/* SECTION TITLE */
.section-title {
  font-family: var(--mono); font-size: 0.7rem; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--muted); margin-bottom: 12px;
  display: flex; align-items: center; gap: 10px;
}
.section-title::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

/* CARDS */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden; margin-bottom: 20px;
}
.card-head {
  padding: 14px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px;
}
.card-title { font-size: 0.88rem; font-weight: 600; }
.card-badge {
  margin-left: auto; font-family: var(--mono); font-size: 0.65rem;
  color: var(--muted); background: var(--surface2);
  border: 1px solid var(--border2); border-radius: 4px; padding: 2px 8px;
}
.card-body { padding: 16px 20px; }

/* GRID */
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

/* HEATMAP GRID */
.heatmap-grid {
  display: flex; flex-wrap: wrap; gap: 6px; padding: 16px 20px;
}
.hm-cell {
  border-radius: 6px; padding: 8px 10px; cursor: pointer;
  transition: transform 0.15s, filter 0.15s;
  min-width: 72px; text-align: center;
  border: 1px solid transparent;
  user-select: none;
}
.hm-cell:hover { transform: scale(1.06); filter: brightness(1.2); border-color: rgba(255,255,255,0.2); }
.hm-ticker { font-family: var(--mono); font-size: 0.72rem; font-weight: 600; }
.hm-ret { font-family: var(--mono); font-size: 0.7rem; margin-top: 2px; }

/* TABLE */
.tbl-wrap { overflow-x: auto; }
table {
  width: 100%; border-collapse: collapse;
  font-family: var(--mono); font-size: 0.78rem;
}
th {
  background: var(--surface2); color: var(--muted);
  font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em;
  padding: 10px 14px; text-align: right; border-bottom: 1px solid var(--border);
  cursor: pointer; user-select: none; white-space: nowrap;
}
th:first-child { text-align: left; }
th:hover { color: var(--text); }
td {
  padding: 9px 14px; border-bottom: 1px solid var(--border);
  text-align: right; white-space: nowrap; color: var(--muted2);
  transition: background 0.1s;
}
td:first-child { text-align: left; color: var(--text); }
tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--surface2); cursor: pointer; }
.pos { color: var(--green) !important; }
.neg { color: var(--red) !important; }
.ticker-link { font-weight: 600; color: var(--accent) !important; }
.type-badge {
  font-size: 0.6rem; padding: 2px 6px; border-radius: 3px;
  background: var(--surface2); border: 1px solid var(--border2);
  color: var(--muted2); white-space: nowrap;
}

/* MODAL */
.modal-overlay {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.75); backdrop-filter: blur(4px);
  align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 12px; width: 92vw; max-width: 960px;
  max-height: 90vh; overflow: hidden;
  display: flex; flex-direction: column;
  animation: modalIn 0.2s ease;
}
@keyframes modalIn {
  from { opacity: 0; transform: translateY(16px) scale(0.98); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.modal-head {
  padding: 16px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 14px;
}
.modal-ticker { font-family: var(--mono); font-size: 1.2rem; font-weight: 600; color: var(--accent); }
.modal-price { font-family: var(--mono); font-size: 1rem; color: var(--text); }
.modal-ret { font-family: var(--mono); font-size: 0.85rem; font-weight: 600; }
.modal-type { font-family: var(--mono); font-size: 0.72rem; color: var(--muted); }
.modal-close {
  margin-left: auto; background: none; border: 1px solid var(--border2);
  color: var(--muted); font-size: 1.1rem; width: 30px; height: 30px;
  border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s;
}
.modal-close:hover { background: var(--surface2); color: var(--text); }
.modal-tabs {
  display: flex; gap: 0; border-bottom: 1px solid var(--border); padding: 0 20px;
}
.modal-tab {
  font-family: var(--mono); font-size: 0.72rem; text-transform: uppercase;
  letter-spacing: 0.08em; padding: 10px 16px; cursor: pointer;
  color: var(--muted); border-bottom: 2px solid transparent;
  transition: color 0.15s, border-color 0.15s;
}
.modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.modal-body { flex: 1; overflow: auto; padding: 4px; }
#modal-chart { min-height: 420px; }

/* CHART CONTAINERS */
.chart-container { min-height: 320px; }

/* RANGE BUTTONS */
.range-btns {
  display: flex; gap: 6px; padding: 12px 20px 0;
}
.range-btn {
  font-family: var(--mono); font-size: 0.68rem; padding: 4px 10px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 4px; color: var(--muted); cursor: pointer;
  transition: all 0.15s;
}
.range-btn:hover, .range-btn.active { background: var(--accent2); border-color: var(--accent); color: #fff; }

/* LOADING */
.loading {
  display: flex; align-items: center; justify-content: center;
  height: 300px; font-family: var(--mono); font-size: 0.8rem; color: var(--muted);
  gap: 10px;
}
.spinner {
  width: 18px; height: 18px; border: 2px solid var(--border2);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* FOOTER */
.footer {
  text-align: center; margin-top: 60px;
  font-family: var(--mono); font-size: 0.68rem; color: var(--muted);
}

/* COMPARATOR */
.comp-selector {
  display: flex; flex-wrap: wrap; gap: 8px; padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}
.comp-tag {
  font-family: var(--mono); font-size: 0.72rem;
  padding: 5px 12px; border-radius: 4px; cursor: pointer;
  border: 1px solid var(--border2); color: var(--muted2);
  background: var(--surface2); transition: all 0.15s; user-select: none;
}
.comp-tag:hover { border-color: var(--accent); color: var(--accent); }
.comp-tag.selected-0 { background: #1e3a5f; border-color: #3b82f6; color: #93c5fd; }
.comp-tag.selected-1 { background: #1a3a2a; border-color: #22c55e; color: #86efac; }
.comp-tag.selected-2 { background: #3a1a1a; border-color: #f59e0b; color: #fcd34d; }
.comp-tag.selected-3 { background: #2a1a3a; border-color: #a855f7; color: #d8b4fe; }
.comp-tag.selected-4 { background: #3a2a1a; border-color: #f97316; color: #fdba74; }
.comp-controls {
  padding: 12px 20px; display: flex; align-items: center; gap: 10px;
  border-bottom: 1px solid var(--border); flex-wrap: wrap;
}
.comp-info {
  font-family: var(--mono); font-size: 0.72rem; color: var(--muted);
}
.comp-clear {
  font-family: var(--mono); font-size: 0.7rem; padding: 4px 12px;
  background: none; border: 1px solid var(--border2); border-radius: 4px;
  color: var(--muted); cursor: pointer; transition: all 0.15s; margin-left: auto;
}
.comp-clear:hover { border-color: var(--red); color: var(--red); }
.comp-mode-btn {
  font-family: var(--mono); font-size: 0.7rem; padding: 4px 10px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 4px; color: var(--muted); cursor: pointer; transition: all 0.15s;
}
.comp-mode-btn.active { background: var(--accent2); border-color: var(--accent); color: #fff; }

/* SEARCH RESULTS */
.search-results {
  position: absolute; top: 52px; left: 0; right: 0;
  background: var(--surface); border-bottom: 1px solid var(--border);
  z-index: 99; display: none; flex-wrap: wrap; gap: 6px; padding: 12px 28px;
}
.search-results.open { display: flex; }
.search-tag {
  font-family: var(--mono); font-size: 0.72rem;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 4px; padding: 4px 10px; cursor: pointer;
  color: var(--muted2); transition: all 0.15s;
}
.search-tag:hover { border-color: var(--accent); color: var(--accent); }

/* TYPE FILTER TABS */
.type-tabs {
  display: flex; flex-wrap: wrap; gap: 6px; padding: 12px 20px;
  border-bottom: 1px solid var(--border);
}
.type-tab {
  font-family: var(--mono); font-size: 0.68rem; padding: 4px 12px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 4px; color: var(--muted); cursor: pointer;
  transition: all 0.15s; user-select: none;
}
.type-tab:hover { border-color: var(--accent); color: var(--accent); }
.type-tab.active { background: var(--accent2); border-color: var(--accent); color: #fff; }

@media (max-width: 900px) {
  .kpi-row { grid-template-columns: repeat(3, 1fr); }
  .grid2 { grid-template-columns: 1fr; }
  .wrap { padding: 16px 14px 60px; }
  .topbar { padding: 0 14px; }
}
@media (max-width: 560px) {
  .kpi-row { grid-template-columns: repeat(2, 1fr); }
  .topbar-search { width: 110px; }
}
</style>
</head>
<body>

<div id="topbar" class="topbar">
  <a href="../index.html" style="font-family:var(--mono);font-size:0.72rem;color:var(--muted);text-decoration:none;white-space:nowrap;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--muted)'">‚Üê Inicio</a>
  <div class="topbar-sep"></div>
  <span class="topbar-logo">‚ñ™ Bonos ARG</span>
  <div class="topbar-sep"></div>
  <span id="topbar-sentiment" class="topbar-sentiment"></span>
  <input type="text" class="topbar-search" id="search" placeholder="Buscar bono..." autocomplete="off">
  <span id="topbar-meta" class="topbar-meta"></span>
</div>

<div id="search-results" class="search-results"></div>

<div class="wrap">
  <div id="loading" class="loading"><div class="spinner"></div> Cargando datos...</div>

  <div id="app" style="display:none">

    <div class="kpi-row" id="kpi-row"></div>

    <div class="summary" id="summary"></div>

    <div class="section-title">Mapa de variaciones</div>
    <div class="card" style="margin-bottom:20px">
      <div class="card-head">
        <span class="card-title">Heatmap</span>
        <span class="card-badge" id="hm-badge"></span>
      </div>
      <div class="type-tabs" id="hm-type-tabs"></div>
      <div id="heatmap-grid" class="heatmap-grid"></div>
    </div>

    <div class="section-title">Distribuci√≥n</div>
    <div class="card" style="margin-bottom:20px">
      <div class="card-head"><span class="card-title">Histograma de retornos diarios</span></div>
      <div class="card-body">
        <div id="hist-chart" class="chart-container"></div>
      </div>
    </div>

    <div class="section-title">Ranking</div>
    <div class="grid2">
      <div class="card">
        <div class="card-head">
          <span class="card-title">üü¢ Top Ganadores</span>
          <span class="card-badge">click para ver velas</span>
        </div>
        <div class="tbl-wrap"><table id="tbl-gainers"><thead></thead><tbody></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-head">
          <span class="card-title">üî¥ Top Perdedores</span>
          <span class="card-badge">click para ver velas</span>
        </div>
        <div class="tbl-wrap"><table id="tbl-losers"><thead></thead><tbody></tbody></table></div>
      </div>
    </div>

    <div class="section-title">Comparador de bonos</div>
    <div class="card" style="margin-bottom:20px">
      <div class="card-head">
        <span class="card-title">Comparar performance hist√≥rica</span>
        <span class="card-badge">hasta 5 bonos</span>
      </div>
      <div class="comp-controls">
        <span class="comp-info" id="comp-info">Seleccion√° bonos abajo para comparar</span>
        <button class="comp-mode-btn active" id="btn-retacum" onclick="setCompMode('retacum')">Retorno acumulado</button>
        <button class="comp-mode-btn" id="btn-precio" onclick="setCompMode('precio')">Precio normalizado</button>
        <button class="comp-mode-btn" id="btn-volcomp" onclick="setCompMode('volcomp')">Volumen</button>
        <button class="comp-clear" onclick="clearComp()">Limpiar</button>
      </div>
      <div class="comp-selector" id="comp-selector"></div>
      <div class="range-btns" id="comp-range-btns" style="padding:12px 20px 0">
        <button class="range-btn" data-days="30">1M</button>
        <button class="range-btn" data-days="90">3M</button>
        <button class="range-btn active" data-days="365">1A</button>
        <button class="range-btn" data-days="1095">3A</button>
        <button class="range-btn" data-days="99999">Todo</button>
      </div>
      <div class="card-body">
        <div id="comp-chart" style="min-height:360px"></div>
      </div>
    </div>

    <div class="section-title">Panel completo</div>
    <div class="card">
      <div class="card-head">
        <span class="card-title">Todos los bonos</span>
        <span class="card-badge" id="full-badge"></span>
      </div>
      <div class="tbl-wrap"><table id="tbl-full"><thead></thead><tbody></tbody></table></div>
    </div>

    <div class="footer" id="footer"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-ticker" id="modal-ticker"></span>
      <span class="modal-price" id="modal-price"></span>
      <span class="modal-ret" id="modal-ret"></span>
      <span class="modal-type" id="modal-type"></span>
      <button class="modal-close" id="modal-close">‚úï</button>
    </div>
    <div class="modal-tabs">
      <div class="modal-tab active" data-tab="candles">Velas</div>
      <div class="modal-tab" data-tab="volume">Volumen</div>
      <div class="modal-tab" data-tab="returns">Retornos</div>
      <div class="modal-tab" data-tab="indicators">Indicadores</div>
    </div>
    <div class="range-btns" id="range-btns">
      <button class="range-btn" data-days="30">1M</button>
      <button class="range-btn" data-days="90">3M</button>
      <button class="range-btn" data-days="180">6M</button>
      <button class="range-btn active" data-days="365">1A</button>
      <button class="range-btn" data-days="1095">3A</button>
      <button class="range-btn" data-days="99999">Todo</button>
    </div>
    <div class="modal-body">
      <div id="modal-chart"></div>
    </div>
  </div>
</div>

<script>
let DATA = null;
let currentTicker = null;
let currentDays = 365;
let currentTab = 'candles';
let hmTypeFilter = 'Todos';

const PLOTLY_LAYOUT_BASE = {
  paper_bgcolor: '#111520', plot_bgcolor: '#111520',
  font: { family: 'IBM Plex Mono', color: '#8899aa', size: 11 },
  margin: { t: 20, r: 20, b: 40, l: 60 },
  xaxis: { gridcolor: '#1e2535', linecolor: '#1e2535', tickfont: { size: 10 } },
  yaxis: { gridcolor: '#1e2535', linecolor: '#1e2535', tickfont: { size: 10 } },
};

function heatColor(v) {
  if (v > 4)  return { bg: '#14532d', text: '#4ade80' };
  if (v > 2)  return { bg: '#166534', text: '#86efac' };
  if (v > 0.5) return { bg: '#15803d44', text: '#22c55e' };
  if (v > -0.5) return { bg: '#1e2535', text: '#8899aa' };
  if (v > -2) return { bg: '#7f1d1d44', text: '#f87171' };
  if (v > -4) return { bg: '#991b1b', text: '#fca5a5' };
  return { bg: '#7f1d1d', text: '#fecaca' };
}

function fmt(v, dec=2) { return v.toFixed(dec); }
function fmtK(v) {
  if (v >= 1e9) return (v/1e9).toFixed(1) + 'B';
  if (v >= 1e6) return (v/1e6).toFixed(1) + 'M';
  if (v >= 1e3) return (v/1e3).toFixed(0) + 'K';
  return v.toString();
}

async function loadData() {
  try {
    const r = await fetch('data.json?' + Date.now());
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    DATA = await r.json();
    render();
  } catch (e) {
    document.getElementById('loading').innerHTML =
      `<div style="text-align:center;color:var(--muted);font-family:var(--mono);font-size:0.82rem;padding:40px">
        <div style="font-size:2rem;margin-bottom:16px">‚ö†</div>
        <div style="color:var(--red);margin-bottom:8px">data.json no encontrado</div>
        <div>Ejecut√° el script para generar los datos:</div>
        <div style="margin-top:12px;background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:12px 20px;display:inline-block">
          cd bonos<br>python generate_dashboard.py
        </div>
      </div>`;
  }
}

function render() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';

  const s = DATA.market_summary;
  const tickers = DATA.tickers;

  // Topbar
  const sentEl = document.getElementById('topbar-sentiment');
  sentEl.textContent = s.sentiment;
  const isPos = s.ad_ratio >= 1;
  sentEl.style.color = isPos ? 'var(--green)' : 'var(--red)';
  sentEl.style.borderColor = isPos ? '#166534' : '#7f1d1d';
  sentEl.style.background = isPos ? '#14532d33' : '#7f1d1d33';
  document.getElementById('topbar-meta').textContent = `Actualizado: ${DATA.generated_at}`;

  // KPIs
  const kpis = [
    { label: 'Total', val: s.total_stocks, cls: 'acc' },
    { label: 'Alcistas', val: s.advances, cls: 'pos' },
    { label: 'Bajistas', val: s.declines, cls: 'neg' },
    { label: 'Ratio A/D', val: fmt(s.ad_ratio), cls: s.ad_ratio >= 1 ? 'pos' : 'neg' },
    { label: 'Promedio', val: (s.avg_change >= 0 ? '+' : '') + fmt(s.avg_change) + '%', cls: s.avg_change >= 0 ? 'pos' : 'neg' },
    { label: 'Mediana', val: (s.median_change >= 0 ? '+' : '') + fmt(s.median_change) + '%', cls: s.median_change >= 0 ? 'pos' : 'neg' },
  ];
  document.getElementById('kpi-row').innerHTML = kpis.map(k =>
    `<div class="kpi"><div class="kpi-label">${k.label}</div><div class="kpi-val ${k.cls}">${k.val}</div></div>`
  ).join('');

  // Summary
  document.getElementById('summary').innerHTML =
    `<div class="summary-label">Resumen ejecutivo</div>${s.executive_summary}`;

  // Type filter tabs for heatmap
  const types = ['Todos', ...new Set(tickers.map(t => t.bond_type))];
  document.getElementById('hm-type-tabs').innerHTML = types.map(tp =>
    `<span class="type-tab${tp === 'Todos' ? ' active' : ''}" onclick="setHmType('${tp}', this)">${tp}</span>`
  ).join('');

  // Heatmap
  renderHeatmap(tickers);
  document.getElementById('hm-badge').textContent = `${tickers.length} instrumentos`;

  // Histogram
  renderHistogram(tickers);

  // Tables
  const gainers = [...tickers].sort((a,b) => b.daily_ret - a.daily_ret).slice(0, 15);
  const losers  = [...tickers].sort((a,b) => a.daily_ret - b.daily_ret).slice(0, 15);
  renderTable('tbl-gainers', gainers);
  renderTable('tbl-losers',  losers);
  renderTable('tbl-full',    [...tickers].sort((a,b) => b.daily_ret - a.daily_ret), true);
  document.getElementById('full-badge').textContent = `${tickers.length} bonos`;

  // Footer
  document.getElementById('footer').textContent = `datos: data912.com ¬∑ ${DATA.generated_at} ¬∑ solo con fines informativos`;

  // Comparator
  initComparator(tickers);
}

function setHmType(type, el) {
  hmTypeFilter = type;
  document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderHeatmap(DATA.tickers);
}

function renderHeatmap(tickers) {
  const filtered = hmTypeFilter === 'Todos'
    ? tickers
    : tickers.filter(t => t.bond_type === hmTypeFilter);
  const sorted = [...filtered].sort((a,b) => b.daily_ret - a.daily_ret);
  document.getElementById('heatmap-grid').innerHTML = sorted.map(t => {
    const c = heatColor(t.daily_ret);
    const sign = t.daily_ret >= 0 ? '+' : '';
    return `<div class="hm-cell" style="background:${c.bg};color:${c.text}"
      onclick="openModal('${t.ticker}')" title="${t.ticker} ¬∑ ${t.bond_type}: ${sign}${fmt(t.daily_ret)}%">
      <div class="hm-ticker">${t.ticker}</div>
      <div class="hm-ret">${sign}${fmt(t.daily_ret)}%</div>
    </div>`;
  }).join('');
}

function renderHistogram(tickers) {
  const rets = tickers.map(t => t.daily_ret);
  const pos = rets.filter(r => r > 0);
  const neg = rets.filter(r => r < 0);
  const neu = rets.filter(r => r === 0);

  Plotly.newPlot('hist-chart', [
    { x: neg, type: 'histogram', name: 'Bajistas', marker: { color: '#ef4444aa' }, nbinsx: 20 },
    { x: neu, type: 'histogram', name: 'Sin cambio', marker: { color: '#5a6a85aa' }, nbinsx: 5 },
    { x: pos, type: 'histogram', name: 'Alcistas', marker: { color: '#22c55eaa' }, nbinsx: 20 },
    { x: [DATA.market_summary.avg_change], y: [0], type: 'scatter', mode: 'markers+text',
      name: 'Promedio', marker: { color: '#3b82f6', size: 10, symbol: 'line-ns', line: { width: 2, color: '#3b82f6' }},
      text: [`  Œº ${fmt(DATA.market_summary.avg_change)}%`], textposition: 'middle right',
      textfont: { color: '#3b82f6', size: 10 } },
  ], {
    ...PLOTLY_LAYOUT_BASE,
    height: 260,
    barmode: 'overlay',
    showlegend: true,
    legend: { orientation: 'h', y: 1.1, font: { size: 10 }, bgcolor: 'transparent' },
    xaxis: { ...PLOTLY_LAYOUT_BASE.xaxis, title: { text: 'Retorno %', font: { size: 10 } } },
    yaxis: { ...PLOTLY_LAYOUT_BASE.yaxis, title: { text: 'N¬∫ bonos', font: { size: 10 } } },
  }, { displayModeBar: false, responsive: true });
}

const TABLE_HEADERS = ['Ticker', 'Tipo', 'Precio', 'Cambio %', 'Volumen', 'Vol Rel'];
function renderTable(id, data, sortable = false) {
  const tbl = document.getElementById(id);
  tbl.querySelector('thead').innerHTML = `<tr>${TABLE_HEADERS.map((h,i) =>
    `<th onclick="sortTable('${id}',${i})">${h}</th>`).join('')}</tr>`;
  tbl.querySelector('tbody').innerHTML = data.map(t => {
    const sign = t.daily_ret >= 0 ? '+' : '';
    const cls  = t.daily_ret > 0 ? 'pos' : t.daily_ret < 0 ? 'neg' : '';
    return `<tr onclick="openModal('${t.ticker}')">
      <td><span class="ticker-link">${t.ticker}</span></td>
      <td style="text-align:left"><span class="type-badge">${t.bond_type || '‚Äî'}</span></td>
      <td>$${fmt(t.close_last)}</td>
      <td class="${cls}">${sign}${fmt(t.daily_ret)}%</td>
      <td>${fmtK(t.volume_last)}</td>
      <td>${fmt(t.vol_rel20)}x</td>
    </tr>`;
  }).join('');
}

function sortTable(id, colIdx) {
  const tbl = document.getElementById(id);
  const rows = Array.from(tbl.querySelectorAll('tbody tr'));
  const asc = tbl.dataset.sortCol == colIdx && tbl.dataset.sortDir == 'asc';
  rows.sort((a, b) => {
    const av = a.cells[colIdx].textContent.replace(/[^0-9.-]/g,'');
    const bv = b.cells[colIdx].textContent.replace(/[^0-9.-]/g,'');
    const an = parseFloat(av), bn = parseFloat(bv);
    const cmp = isNaN(an) ? av.localeCompare(bv) : an - bn;
    return asc ? -cmp : cmp;
  });
  rows.forEach(r => tbl.querySelector('tbody').appendChild(r));
  tbl.dataset.sortCol = colIdx;
  tbl.dataset.sortDir = asc ? 'desc' : 'asc';
}

// SEARCH
document.getElementById('search').addEventListener('input', function() {
  const q = this.value.trim().toUpperCase();
  const resultsEl = document.getElementById('search-results');
  if (!q || !DATA) { resultsEl.classList.remove('open'); return; }
  const matches = DATA.tickers.filter(t => t.ticker.includes(q));
  if (!matches.length) { resultsEl.classList.remove('open'); return; }
  resultsEl.innerHTML = matches.map(t =>
    `<span class="search-tag" onclick="openModal('${t.ticker}');document.getElementById('search').value='';document.getElementById('search-results').classList.remove('open')">${t.ticker} <span style="color:var(--muted)">${t.daily_ret>=0?'+':''}${fmt(t.daily_ret)}%</span></span>`
  ).join('');
  resultsEl.classList.add('open');
});
document.addEventListener('click', e => {
  if (!e.target.closest('#search') && !e.target.closest('#search-results'))
    document.getElementById('search-results').classList.remove('open');
});

// MODAL
function openModal(ticker) {
  const t = DATA.tickers.find(x => x.ticker === ticker);
  if (!t) return;
  currentTicker = ticker;
  document.getElementById('modal-ticker').textContent = ticker;
  document.getElementById('modal-price').textContent = `$${fmt(t.close_last)}`;
  const ret = document.getElementById('modal-ret');
  const sign = t.daily_ret >= 0 ? '+' : '';
  ret.textContent = `${sign}${fmt(t.daily_ret)}%`;
  ret.className = 'modal-ret ' + (t.daily_ret > 0 ? 'pos' : t.daily_ret < 0 ? 'neg' : '');
  document.getElementById('modal-type').textContent = t.bond_type || '';
  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  renderModalChart();
}

document.getElementById('modal-close').addEventListener('click', closeModal);
document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
});
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

document.querySelectorAll('.modal-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    currentTab = this.dataset.tab;
    renderModalChart();
  });
});

document.querySelectorAll('.range-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentDays = parseInt(this.dataset.days);
    renderModalChart();
  });
});

// --- INDICATOR HELPERS ---
function calcMA(closes, period) {
  return closes.map((_, i) => {
    if (i < period - 1) return null;
    const slice = closes.slice(i - period + 1, i + 1);
    return slice.reduce((a,b) => a+b, 0) / period;
  });
}

function calcRSI(closes, period = 14) {
  const rsi = new Array(closes.length).fill(null);
  if (closes.length < period + 1) return rsi;
  let gains = 0, losses = 0;
  for (let i = 1; i <= period; i++) {
    const diff = closes[i] - closes[i-1];
    if (diff >= 0) gains += diff; else losses -= diff;
  }
  let avgGain = gains / period;
  let avgLoss = losses / period;
  rsi[period] = avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));
  for (let i = period + 1; i < closes.length; i++) {
    const diff = closes[i] - closes[i-1];
    avgGain = (avgGain * (period-1) + Math.max(diff, 0)) / period;
    avgLoss = (avgLoss * (period-1) + Math.max(-diff, 0)) / period;
    rsi[i] = avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));
  }
  return rsi;
}

function calcBollinger(closes, period = 20, mult = 2) {
  const mid = calcMA(closes, period);
  const upper = [], lower = [];
  closes.forEach((_, i) => {
    if (i < period - 1) { upper.push(null); lower.push(null); return; }
    const slice = closes.slice(i - period + 1, i + 1);
    const mean = mid[i];
    const std = Math.sqrt(slice.reduce((s,v) => s + (v-mean)**2, 0) / period);
    upper.push(mean + mult * std);
    lower.push(mean - mult * std);
  });
  return { mid, upper, lower };
}

function renderModalChart() {
  if (!currentTicker) return;
  const t = DATA.tickers.find(x => x.ticker === currentTicker);
  if (!t) return;

  const fullHist = t.history;
  let hist = fullHist;
  if (currentDays < 99999) {
    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - currentDays);
    hist = fullHist.filter(h => new Date(h.date) >= cutoff);
  }
  const dates = hist.map(h => h.date);
  const closes = hist.map(h => h.close);

  let traces = [];
  let layout = {
    ...PLOTLY_LAYOUT_BASE,
    height: 420,
    margin: { t: 10, r: 20, b: 40, l: 65 },
    xaxis: { ...PLOTLY_LAYOUT_BASE.xaxis, rangeslider: { visible: false } },
  };

  if (currentTab === 'candles') {
    traces = [{
      type: 'candlestick',
      x: dates, open: hist.map(h=>h.open), high: hist.map(h=>h.high),
      low: hist.map(h=>h.low), close: hist.map(h=>h.close),
      increasing: { line: { color: '#22c55e' }, fillcolor: '#22c55e44' },
      decreasing: { line: { color: '#ef4444' }, fillcolor: '#ef444444' },
      name: currentTicker,
    }];

  } else if (currentTab === 'volume') {
    const colors = hist.map((h,i) => i === 0 ? '#3b82f6' : h.close >= hist[i-1].close ? '#22c55e' : '#ef4444');
    traces = [{
      type: 'bar', x: dates, y: hist.map(h=>h.volume),
      marker: { color: colors }, name: 'Volumen',
    }];

  } else if (currentTab === 'returns') {
    const rets = closes.map((c,i) => i === 0 ? 0 : ((c/closes[i-1])-1)*100);
    traces = [{
      type: 'scatter', mode: 'lines', x: dates, y: rets,
      line: { color: '#3b82f6', width: 1.5 },
      fill: 'tozeroy', fillcolor: '#3b82f611', name: 'Retorno %',
    }];

  } else if (currentTab === 'indicators') {
    const ma20  = calcMA(closes, 20);
    const ma50  = calcMA(closes, 50);
    const ma200 = calcMA(closes, 200);
    const rsi   = calcRSI(closes, 14);
    const boll  = calcBollinger(closes, 20, 2);

    layout = {
      ...PLOTLY_LAYOUT_BASE,
      height: 520,
      margin: { t: 10, r: 20, b: 40, l: 65 },
      grid: { rows: 2, columns: 1, pattern: 'independent', roworder: 'top to bottom' },
      xaxis:  { ...PLOTLY_LAYOUT_BASE.xaxis, domain: [0, 1], anchor: 'y' },
      yaxis:  { ...PLOTLY_LAYOUT_BASE.yaxis, domain: [0.35, 1] },
      xaxis2: { ...PLOTLY_LAYOUT_BASE.xaxis, domain: [0, 1], anchor: 'y2' },
      yaxis2: { ...PLOTLY_LAYOUT_BASE.yaxis, domain: [0, 0.28], range: [0, 100] },
      showlegend: true,
      legend: { orientation: 'h', y: 1.05, font: { size: 10 }, bgcolor: 'transparent' },
      shapes: [
        { type:'line', x0:dates[0], x1:dates[dates.length-1], y0:70, y1:70,
          xref:'x2', yref:'y2', line:{ color:'#ef444466', width:1, dash:'dot' } },
        { type:'line', x0:dates[0], x1:dates[dates.length-1], y0:30, y1:30,
          xref:'x2', yref:'y2', line:{ color:'#22c55e66', width:1, dash:'dot' } },
      ],
      annotations: [
        { x:1, y:70, xref:'paper', yref:'y2', text:'70', showarrow:false,
          font:{ size:9, color:'#ef4444' }, xanchor:'right' },
        { x:1, y:30, xref:'paper', yref:'y2', text:'30', showarrow:false,
          font:{ size:9, color:'#22c55e' }, xanchor:'right' },
        { x:0, y:0.31, xref:'paper', yref:'paper', text:'RSI(14)',
          showarrow:false, font:{ size:9, color:'#8899aa' }, xanchor:'left' },
      ],
    };

    traces = [
      { type:'scatter', mode:'lines', x:dates, y:boll.upper, xaxis:'x', yaxis:'y',
        line:{ color:'transparent' }, showlegend:false, hoverinfo:'skip', name:'BB upper' },
      { type:'scatter', mode:'lines', x:dates, y:boll.lower, xaxis:'x', yaxis:'y',
        fill:'tonexty', fillcolor:'#3b82f611', line:{ color:'transparent' },
        showlegend:false, hoverinfo:'skip', name:'BB lower' },
      { type:'scatter', mode:'lines', x:dates, y:closes, xaxis:'x', yaxis:'y',
        line:{ color:'#e2e8f0', width:1.5 }, name:'Precio' },
      { type:'scatter', mode:'lines', x:dates, y:boll.mid, xaxis:'x', yaxis:'y',
        line:{ color:'#3b82f666', width:1, dash:'dot' }, name:'BB(20)' },
      { type:'scatter', mode:'lines', x:dates, y:ma20, xaxis:'x', yaxis:'y',
        line:{ color:'#f59e0b', width:1.5 }, name:'MA20' },
      { type:'scatter', mode:'lines', x:dates, y:ma50, xaxis:'x', yaxis:'y',
        line:{ color:'#22c55e', width:1.5 }, name:'MA50' },
      { type:'scatter', mode:'lines', x:dates, y:ma200, xaxis:'x', yaxis:'y',
        line:{ color:'#ef4444', width:1.5 }, name:'MA200' },
      { type:'scatter', mode:'lines', x:dates, y:rsi, xaxis:'x2', yaxis:'y2',
        line:{ color:'#a855f7', width:1.5 }, name:'RSI(14)', showlegend:false },
    ];
  }

  Plotly.react('modal-chart', traces, layout, { displayModeBar: false, responsive: true });
}

// COMPARATOR
const COMP_COLORS = ['#3b82f6','#22c55e','#f59e0b','#a855f7','#f97316'];
let compSelected = [];
let compMode = 'retacum';
let compDays = 365;

function initComparator(tickers) {
  const sorted = [...tickers].sort((a,b) => a.ticker.localeCompare(b.ticker));
  document.getElementById('comp-selector').innerHTML = sorted.map(t => {
    const sign = t.daily_ret >= 0 ? '+' : '';
    return `<span class="comp-tag" id="ctag-${t.ticker}" onclick="toggleComp('${t.ticker}')">${t.ticker} <span style="opacity:0.6">${sign}${fmt(t.daily_ret)}%</span></span>`;
  }).join('');

  document.querySelectorAll('#comp-range-btns .range-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#comp-range-btns .range-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      compDays = parseInt(this.dataset.days);
      renderComp();
    });
  });
}

function toggleComp(ticker) {
  const idx = compSelected.indexOf(ticker);
  if (idx > -1) {
    compSelected.splice(idx, 1);
  } else {
    if (compSelected.length >= 5) return;
    compSelected.push(ticker);
  }
  updateCompTags();
  renderComp();
}

function updateCompTags() {
  document.querySelectorAll('.comp-tag').forEach(el => {
    el.className = 'comp-tag';
  });
  compSelected.forEach((tk, i) => {
    const el = document.getElementById('ctag-' + tk);
    if (el) el.classList.add('selected-' + i);
  });
  const info = document.getElementById('comp-info');
  info.textContent = compSelected.length === 0
    ? 'Seleccion√° bonos abajo para comparar'
    : `Comparando: ${compSelected.join(', ')}`;
}

function clearComp() {
  compSelected = [];
  updateCompTags();
  Plotly.purge('comp-chart');
  document.getElementById('comp-info').textContent = 'Seleccion√° bonos abajo para comparar';
}

function setCompMode(mode) {
  compMode = mode;
  ['retacum','precio','volcomp'].forEach(m => {
    document.getElementById('btn-' + m).classList.toggle('active', m === mode);
  });
  renderComp();
}

function filterHistory(history) {
  if (compDays >= 99999) return history;
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - compDays);
  return history.filter(h => new Date(h.date) >= cutoff);
}

function renderComp() {
  if (compSelected.length === 0) { Plotly.purge('comp-chart'); return; }

  const traces = compSelected.map((tk, i) => {
    const t = DATA.tickers.find(x => x.ticker === tk);
    const hist = filterHistory(t.history);
    const color = COMP_COLORS[i];
    const dates = hist.map(h => h.date);

    if (compMode === 'retacum') {
      const base = hist[0].close;
      const vals = hist.map(h => ((h.close / base) - 1) * 100);
      return { type: 'scatter', mode: 'lines', x: dates, y: vals,
        name: tk, line: { color, width: 2 } };

    } else if (compMode === 'precio') {
      const base = hist[0].close;
      const vals = hist.map(h => (h.close / base) * 100);
      return { type: 'scatter', mode: 'lines', x: dates, y: vals,
        name: tk, line: { color, width: 2 } };

    } else {
      return { type: 'bar', x: dates, y: hist.map(h => h.volume),
        name: tk, marker: { color: color + '99' }, opacity: 0.8 };
    }
  });

  const yTitle = compMode === 'retacum' ? 'Retorno acumulado %'
               : compMode === 'precio'  ? 'Precio base 100'
               : 'Volumen';

  Plotly.react('comp-chart', traces, {
    ...PLOTLY_LAYOUT_BASE,
    height: 360,
    barmode: 'group',
    showlegend: true,
    legend: { orientation: 'h', y: 1.08, font: { size: 11 }, bgcolor: 'transparent' },
    yaxis: { ...PLOTLY_LAYOUT_BASE.yaxis, title: { text: yTitle, font: { size: 10 } } },
    shapes: compMode === 'retacum' ? [{
      type: 'line', x0: traces[0].x[0], x1: traces[0].x[traces[0].x.length-1],
      y0: 0, y1: 0, line: { color: '#5a6a85', width: 1, dash: 'dot' }
    }] : [],
  }, { displayModeBar: false, responsive: true });
}

loadData();
</script>
</body>
</html>
